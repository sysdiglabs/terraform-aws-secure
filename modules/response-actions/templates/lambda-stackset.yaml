AWSTemplateFormatVersion: '2010-09-09'
Description: 'Sysdig Response Actions Lambda Functions - Multi-Region Deployment'

Parameters:
  ResourceName:
    Type: String
    Description: Base name for all resources
  S3BucketPrefix:
    Type: String
    Description: Prefix for regional S3 buckets containing Lambda deployment packages (bucket name will be {prefix}-{region})
  ApiBaseUrl:
    Type: String
    Description: API base URL for Lambda functions
  QuarantineUserRoleArn:
    Type: String
    Description: ARN of the IAM role for quarantine user function
  FetchCloudLogsRoleArn:
    Type: String
    Description: ARN of the IAM role for fetch cloud logs function
  RemovePolicyRoleArn:
    Type: String
    Description: ARN of the IAM role for remove policy function
  ConfigureResourceAccessRoleArn:
    Type: String
    Description: ARN of the IAM role for configure resource access function
  CreateVolumeSnapshotsRoleArn:
    Type: String
    Description: ARN of the IAM role for create volume snapshots function
  DeleteVolumeSnapshotsRoleArn:
    Type: String
    Description: ARN of the IAM role for delete volume snapshots function
  QuarantineUserRoleName:
    Type: String
    Description: Name of the IAM role for quarantine user function
  FetchCloudLogsRoleName:
    Type: String
    Description: Name of the IAM role for fetch cloud logs function
  RemovePolicyRoleName:
    Type: String
    Description: Name of the IAM role for remove policy function
  ConfigureResourceAccessRoleName:
    Type: String
    Description: Name of the IAM role for configure resource access function
  CreateVolumeSnapshotsRoleName:
    Type: String
    Description: Name of the IAM role for create volume snapshots function
  DeleteVolumeSnapshotsRoleName:
    Type: String
    Description: Name of the IAM role for delete volume snapshots function
  CloudLambdasPath:
    Type: String
    Description: The path where lambda code resides inside of regional S3 buckets
  EnableQuarantineUser:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Enable quarantine user and remove policy lambdas
  EnableFetchCloudLogs:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Enable fetch cloud logs lambda
  EnableMakePrivate:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Enable configure resource access lambda
  EnableCreateVolumeSnapshot:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: Enable create and delete volume snapshot lambdas

Conditions:
  CreateQuarantineUserResources: !Equals [!Ref EnableQuarantineUser, "true"]
  CreateFetchCloudLogsResources: !Equals [!Ref EnableFetchCloudLogs, "true"]
  CreateMakePrivateResources: !Equals [!Ref EnableMakePrivate, "true"]
  CreateVolumeSnapshotResources: !Equals [!Ref EnableCreateVolumeSnapshot, "true"]

Resources:
  # CloudWatch Log Groups (Regional Resources)
  QuarantineUserLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateQuarantineUserResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ResourceName}-quarantine-user'
      RetentionInDays: 7

  FetchCloudLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateFetchCloudLogsResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ResourceName}-fetch-cloud-logs'
      RetentionInDays: 7

  RemovePolicyLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateQuarantineUserResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ResourceName}-remove-policy'
      RetentionInDays: 7

  ConfigureResourceAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateMakePrivateResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ResourceName}-configure-resource-access'
      RetentionInDays: 7

  CreateVolumeSnapshotsLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateVolumeSnapshotResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ResourceName}-create-volume-snapshots'
      RetentionInDays: 7

  DeleteVolumeSnapshotsLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateVolumeSnapshotResources
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ResourceName}-delete-volume-snapshots'
      RetentionInDays: 7

  # Lambda Functions (Regional Resources)
  QuarantineUserFunction:
    Type: AWS::Lambda::Function
    Condition: CreateQuarantineUserResources
    DependsOn: QuarantineUserLogGroup
    Properties:
      FunctionName: !Sub '${ResourceName}-quarantine-user'
      Runtime: python3.12
      Handler: app.index.handler
      Role: !Ref QuarantineUserRoleArn
      Code:
        S3Bucket: !Sub '${S3BucketPrefix}-${AWS::Region}'
        S3Key: !Sub '${CloudLambdasPath}/quarantine_user.zip'
      Timeout: 300
      MemorySize: 128
      Environment:
        Variables:
          API_BASE_URL: !Ref ApiBaseUrl
          DELEGATE_ROLE_NAME: !Ref QuarantineUserRoleName
      Tags:
        - Key: Name
          Value: !Sub '${ResourceName}-quarantine-user'
        - Key: 'sysdig.com/response-actions/cloud-actions'
          Value: 'true'

  FetchCloudLogsFunction:
    Type: AWS::Lambda::Function
    Condition: CreateFetchCloudLogsResources
    DependsOn: FetchCloudLogsLogGroup
    Properties:
      FunctionName: !Sub '${ResourceName}-fetch-cloud-logs'
      Runtime: python3.12
      Handler: app.index.handler
      Role: !Ref FetchCloudLogsRoleArn
      Code:
        S3Bucket: !Sub '${S3BucketPrefix}-${AWS::Region}'
        S3Key: !Sub '${CloudLambdasPath}/fetch_cloud_logs.zip'
      Timeout: 300
      MemorySize: 128
      Environment:
        Variables:
          API_BASE_URL: !Ref ApiBaseUrl
          DELEGATE_ROLE_NAME: !Ref FetchCloudLogsRoleName
      Tags:
        - Key: Name
          Value: !Sub '${ResourceName}-fetch-cloud-logs'
        - Key: 'sysdig.com/response-actions/cloud-actions'
          Value: 'true'

  RemovePolicyFunction:
    Type: AWS::Lambda::Function
    Condition: CreateQuarantineUserResources
    DependsOn: RemovePolicyLogGroup
    Properties:
      FunctionName: !Sub '${ResourceName}-remove-policy'
      Runtime: python3.12
      Handler: app.index.handler
      Role: !Ref RemovePolicyRoleArn
      Code:
        S3Bucket: !Sub '${S3BucketPrefix}-${AWS::Region}'
        S3Key: !Sub '${CloudLambdasPath}/remove_policy.zip'
      Timeout: 300
      MemorySize: 128
      Environment:
        Variables:
          API_BASE_URL: !Ref ApiBaseUrl
          DELEGATE_ROLE_NAME: !Ref RemovePolicyRoleName
      Tags:
        - Key: Name
          Value: !Sub '${ResourceName}-remove-policy'
        - Key: 'sysdig.com/response-actions/cloud-actions'
          Value: 'true'

  ConfigureResourceAccessFunction:
    Type: AWS::Lambda::Function
    Condition: CreateMakePrivateResources
    DependsOn: ConfigureResourceAccessLogGroup
    Properties:
      FunctionName: !Sub '${ResourceName}-configure-resource-access'
      Runtime: python3.12
      Handler: app.index.handler
      Role: !Ref ConfigureResourceAccessRoleArn
      Code:
        S3Bucket: !Sub '${S3BucketPrefix}-${AWS::Region}'
        S3Key: !Sub '${CloudLambdasPath}/configure_resource_access.zip'
      Timeout: 300
      MemorySize: 128
      Environment:
        Variables:
          API_BASE_URL: !Ref ApiBaseUrl
          DELEGATE_ROLE_NAME: !Ref ConfigureResourceAccessRoleName
      Tags:
        - Key: Name
          Value: !Sub '${ResourceName}-configure-resource-access'
        - Key: 'sysdig.com/response-actions/cloud-actions'
          Value: 'true'

  CreateVolumeSnapshotsFunction:
    Type: AWS::Lambda::Function
    Condition: CreateVolumeSnapshotResources
    DependsOn: CreateVolumeSnapshotsLogGroup
    Properties:
      FunctionName: !Sub '${ResourceName}-create-volume-snapshots'
      Runtime: python3.12
      Handler: app.index.handler
      Role: !Ref CreateVolumeSnapshotsRoleArn
      Code:
        S3Bucket: !Sub '${S3BucketPrefix}-${AWS::Region}'
        S3Key: !Sub '${CloudLambdasPath}/create_volume_snapshots.zip'
      Timeout: 300
      MemorySize: 128
      Environment:
        Variables:
          API_BASE_URL: !Ref ApiBaseUrl
          DELEGATE_ROLE_NAME: !Ref CreateVolumeSnapshotsRoleName
      Tags:
        - Key: Name
          Value: !Sub '${ResourceName}-create-volume-snapshots'
        - Key: 'sysdig.com/response-actions/cloud-actions'
          Value: 'true'

  DeleteVolumeSnapshotsFunction:
    Type: AWS::Lambda::Function
    Condition: CreateVolumeSnapshotResources
    DependsOn: DeleteVolumeSnapshotsLogGroup
    Properties:
      FunctionName: !Sub '${ResourceName}-delete-volume-snapshots'
      Runtime: python3.12
      Handler: app.index.handler
      Role: !Ref DeleteVolumeSnapshotsRoleArn
      Code:
        S3Bucket: !Sub '${S3BucketPrefix}-${AWS::Region}'
        S3Key: !Sub '${CloudLambdasPath}/delete_volume_snapshots.zip'
      Timeout: 300
      MemorySize: 128
      Environment:
        Variables:
          API_BASE_URL: !Ref ApiBaseUrl
          DELEGATE_ROLE_NAME: !Ref DeleteVolumeSnapshotsRoleName
      Tags:
        - Key: Name
          Value: !Sub '${ResourceName}-delete-volume-snapshots'
        - Key: 'sysdig.com/response-actions/cloud-actions'
          Value: 'true'

Outputs:
  QuarantineUserFunctionArn:
    Condition: CreateQuarantineUserResources
    Value: !GetAtt QuarantineUserFunction.Arn
  FetchCloudLogsFunctionArn:
    Condition: CreateFetchCloudLogsResources
    Value: !GetAtt FetchCloudLogsFunction.Arn
  RemovePolicyFunctionArn:
    Condition: CreateQuarantineUserResources
    Value: !GetAtt RemovePolicyFunction.Arn
  ConfigureResourceAccessFunctionArn:
    Condition: CreateMakePrivateResources
    Value: !GetAtt ConfigureResourceAccessFunction.Arn
  CreateVolumeSnapshotsFunctionArn:
    Condition: CreateVolumeSnapshotResources
    Value: !GetAtt CreateVolumeSnapshotsFunction.Arn
  DeleteVolumeSnapshotsFunctionArn:
    Condition: CreateVolumeSnapshotResources
    Value: !GetAtt DeleteVolumeSnapshotsFunction.Arn
